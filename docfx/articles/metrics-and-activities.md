# Metrics and Activities

ProDataGrid exposes OpenTelemetry-friendly diagnostics via `ActivitySource` and `Meter` so you can track row generation, virtualization, selection changes, and collection view operations.

## Enabling diagnostics

Diagnostics are opt-in. Enable them early in app startup (before any grids are created):

```csharp
AppContext.SetSwitch("ProDataGrid.Diagnostics.IsEnabled", true);
```

## ActivitySource

ActivitySource name: `ProDataGrid.Diagnostic.Source`

Activities emitted:

- `ProDataGrid.DataGrid.RefreshRowsAndColumns`
- `ProDataGrid.DataGrid.RefreshRows`
- `ProDataGrid.DataGrid.UpdateDisplayedRows`
- `ProDataGrid.DataGrid.GenerateRow`
- `ProDataGrid.DataGrid.AutoGenerateColumns`
- `ProDataGrid.DataGrid.SelectionChanged`
- `ProDataGrid.CollectionView.Refresh`
- `ProDataGrid.CollectionView.Filter`
- `ProDataGrid.CollectionView.Sort`
- `ProDataGrid.CollectionView.Group`
- `ProDataGrid.CollectionView.GroupTemporary`
- `ProDataGrid.CollectionView.GroupPage`

Example listener:

```csharp
using System.Diagnostics;

var listener = new ActivityListener
{
    ShouldListenTo = source => source.Name == "ProDataGrid.Diagnostic.Source",
    Sample = static (ref ActivityCreationOptions<ActivityContext> _) => ActivitySamplingResult.AllDataAndRecorded,
    ActivityStopped = activity =>
    {
        // Inspect activity.DisplayName and activity.Tags
    }
};

ActivitySource.AddActivityListener(listener);
```

## Metrics

Meter name: `ProDataGrid.Diagnostic.Meter`

Histograms (ms):

- `prodatagrid.refresh.time` - DataGrid refresh pass (rows + columns).
- `prodatagrid.rows.refresh.time` - Row refresh pass.
- `prodatagrid.rows.display.update.time` - Displayed rows update during virtualization.
- `prodatagrid.rows.generate.time` - Row generation and preparation.
- `prodatagrid.columns.autogen.time` - Auto-generated columns pass.
- `prodatagrid.selection.change.time` - SelectionChanged handling.
- `prodatagrid.collection.refresh.time` - Collection view refresh.
- `prodatagrid.collection.filter.time` - Filtering during refresh.
- `prodatagrid.collection.sort.time` - Sorting during refresh.
- `prodatagrid.collection.group.time` - Grouping during refresh.
- `prodatagrid.collection.group.temporary.time` - Temporary grouping for paging.
- `prodatagrid.collection.group.page.time` - Page-level grouping.

Counters:

- `prodatagrid.rows.realized.count` - Row containers realized.
- `prodatagrid.rows.recycled.count` - Row containers recycled.
- `prodatagrid.rows.prepared.count` - Row containers prepared.
- `prodatagrid.columns.autogen.count` - Columns auto-generated.
- `prodatagrid.selection.changed.count` - SelectionChanged events raised.

## Tags

Activities include context tags such as:

- `ClearRows`, `RecycleRows`, `AutoGenerateColumns`
- `Columns`, `Rows`, `SlotCount`
- `DisplayHeight`, `FirstDisplayedSlot`, `LastDisplayedSlot`, `DisplayedSlots`
- `RowIndex`, `Slot`, `Source` (`existing`, `new`, `recycled`, `own-container`)
- `AddedCount`, `RemovedCount`, `SelectionSource`, `UserInitiated`
- `SortDescriptions`, `GroupDescriptions`, `FilterEnabled`
- `PageSize`, `PageIndex`, `UsesLocalArray`, `IsGrouping`
- `AutoGeneratedColumns`

Counters use `Source` for row realization and `SelectionSource` for selection changes.

## OpenTelemetry integration

```csharp
services.AddOpenTelemetry()
    .WithTracing(builder => builder.AddSource("ProDataGrid.Diagnostic.Source"))
    .WithMetrics(builder => builder.AddMeter("ProDataGrid.Diagnostic.Meter"));
```

## Notes

- Diagnostics are off by default; set the switch before any grid usage.
- Some metrics are nested (e.g. refresh includes filter/sort/group), so prefer comparing like-for-like scenarios.
